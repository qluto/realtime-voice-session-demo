# セッション終了メカニズム実装計画

## 概要

現在のWeekly Reflection Coachingアプリケーションに、コーチングセッションの適切な終了を導くための2つのアプローチを検討・実装する。

## 現在の課題

- セッションは手動終了ボタンのみで終了
- 明確なセッション完了の仕組みが不足
- 振り返りのまとめや統合フェーズが不完全になる可能性

## 提案された2つのアプローチ

### アプローチ1: ユーザー主導のまとめ要求システム

**概念:**
ユーザーがセッションのまとめを要求するボタンを用意し、テキストにてGPT-Realtimeにまとめをさせるトリガーを作る。

**実現可能性:** ✅ **高い**

**技術的根拠:**
- OpenAI Realtime APIは音声とテキストの両方をサポート
- 現在のRealtimeSessionにテキストメッセージ送信機能を追加可能
- UI要素の追加は既存の構造に容易に統合可能

### アプローチ2: AI主導の自動判定システム

**概念:**
コーチが音声対話の裏で、時間管理や良い振り返りがどの程度進んでいるかの採点を行い続け、採点基準もしくは経過時間が一定閾値以上になったらまとめに入ることを促す。

**実現可能性:** ✅ **実現可能（複雑）**

**技術的根拠:**
- 時間ベース判定：既存のセッションタイマーを活用
- 進行度評価：会話ログの内容分析で実装可能
- OpenAI APIを活用した進行度スコアリング

## 実装計画

### Phase 1: ユーザー主導のまとめ機能（推奨優先実装）

#### 1.1 UI拡張
- **まとめボタンの追加**
  - 配置場所: 会話エリア内、conversation-log下部
  - ボタンテキスト: "📝 セッションのまとめを要求"
  - 表示条件: **session.usage.requests >= 4** かつセッション接続中
  - 状態管理: 使用後は非表示、セッション終了時もリセット

#### 1.2 RealtimeSession機能拡張
- **テキスト送信機能の追加**
  - `session.sendMessage()`メソッドの実装
  - まとめリクエストメッセージ: "今までの会話を基に、今週の振り返りの重要なポイントをまとめてください。セッションを自然にクロージングに向けてください。"
  - 既存のusage.requestsカウンターを活用した表示制御

#### 1.3 まとめレスポンス処理
- **音声まとめの提供**
  - コーチが音声でセッションのまとめを提供
  - 音声転写テキストも会話ログに表示
- **自然なセッション終了フロー**
  - まとめ完了後の適切なクロージング
  - セッション終了への誘導

#### 実装ファイル:
- `src/voice-agent.ts`: セッション管理、テキスト送信機能、usage.requests連動
- `src/main.ts`: UIボタンの追加（summary-controls要素）
- `src/style.css`: ボタンスタイリング（.summary-btn, .summary-controls）

#### 実装済み機能:
✅ **usage.requestsベースの表示制御**
✅ **まとめボタンUI（会話ログ下部）**
✅ **session.sendMessage()でのテキスト送信**
✅ **使用後の自動非表示機能**
✅ **セッション終了時のリセット機能**

### Phase 2: AI主導の自動判定システム（オプション実装）

#### 2.1 進行度評価システム
- **会話ログ分析機能**
  - 定期的な会話内容の分析（OpenAI API使用）
  - ICF Core Competencies段階別進捗スコアリング
    - Opening & Agenda Setting
    - Deep Reflection
    - Insight Synthesis
    - Forward Integration
    - Closing

#### 2.2 自動まとめ判定ロジック
- **時間ベース判定**
  - 8-9分経過時の自動判定
  - 既存のセッションタイマーとの統合
- **内容ベース判定**
  - 4つのコーチングフェーズすべてカバー時の判定
  - 振り返りの深度評価

#### 2.3 ユーザーインタラクション
- **まとめ提案機能**
  - "まとめに入りませんか？"の自動提案
  - ユーザー選択肢の提供

#### 2.4 統合UI更新
- **進行度表示**
  - セッション進行度インジケーターの追加
  - 現在のフェーズ表示
- **選択オプション**
  - 自動/手動まとめの選択機能

#### 実装ファイル:
- `src/voice-agent.ts`: 進行度評価とタイミング判定
- `src/session-analyzer.ts`: 新規ファイル - 会話分析機能
- `src/main.ts`: 進行度UI要素の追加
- `src/style.css`: 進行度表示のスタイリング

## 技術仕様

### OpenAI Realtime API活用
```typescript
// テキストメッセージ送信例
await session.sendText({
  type: 'conversation.item.create',
  item: {
    type: 'message',
    role: 'user',
    content: [{ type: 'input_text', text: 'セッションのまとめをお願いします' }]
  }
});
```

### 進行度評価API（Phase 2）
```typescript
// 会話ログ分析例
const progressAnalysis = await openai.chat.completions.create({
  model: 'gpt-4',
  messages: [
    {
      role: 'system',
      content: 'ICFコーチング段階の進行度を0-100で評価してください'
    },
    {
      role: 'user',
      content: conversationLog
    }
  ]
});
```

## 実装優先順位

1. **Phase 1（高優先度）**
   - 迅速な実装が可能
   - ユーザーコントロールを維持
   - 既存アーキテクチャへの影響最小
   - 即座にユーザー体験を向上

2. **Phase 2（中優先度）**
   - Phase 1の成功後に検討
   - より高度な自動化を提供
   - 適切なタイミングでの終了提案
   - 実装複雑度が高い

## 期待される効果

### Phase 1実装後
- セッションの明確な完了感
- 重要な洞察の統合と確認
- ユーザー主導の柔軟な終了タイミング

### Phase 2実装後
- 最適なタイミングでのセッション終了
- コーチング品質の一貫性向上
- セッション時間の効率的活用

## リスク評価

### 技術的リスク
- **低**: 既存のOpenAI Realtime APIと構造を活用
- **Phase 2のみ中**: 会話分析の精度に依存

### ユーザー体験リスク
- **低**: 既存機能を損なわない追加機能
- **Phase 2のみ中**: 自動判定の精度とユーザー受容性

## 成功指標

1. **機能成功指標**
   - まとめ機能の利用率
   - セッション完了率の向上
   - ユーザー満足度の向上

2. **技術成功指標**
   - レスポンス時間の維持
   - エラー率の最小化
   - システム安定性の確保